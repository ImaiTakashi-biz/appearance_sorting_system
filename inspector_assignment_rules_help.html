<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>検査員割当ルール - ヘルプ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #f7fafc;
      color: #0f172a;
      font-family: "Noto Sans JP", "Segoe UI", system-ui, sans-serif;
      margin: 0;
      padding: 2rem 1rem;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 1.2rem;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
      padding: 2rem;
    }
    h1, h2 {
      margin-bottom: 0.5rem;
      color: #0b2c62;
    }
    p {
      line-height: 1.75;
      margin-bottom: 1rem;
    }
    .pill {
      display: inline-flex;
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      background: #e0e7ff;
      color: #1d4ed8;
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    ul {
      padding-left: 1.2rem;
      margin-top: 0;
      margin-bottom: 1rem;
    }
    li {
      margin-bottom: 0.5rem;
    }
    .section {
      margin-bottom: 1.5rem;
    }
    .rule-card {
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      padding: 1rem 1.2rem;
      background: #fdfdfd;
      margin-bottom: 1rem;
    }
    .rule-card strong {
      display: block;
      margin-bottom: 0.4rem;
      color: #0f172a;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="pill">ルール解説</div>
    <h1>検査員割当ルール</h1>
    <p>このヘルプは割当ロジックの主要なルールを誰でもわかる表現でまとめたものです。運用者が現状の挙動を把握しながらご利用ください。</p>

    <div class="section">
      <h2>全体の流れ</h2>
      <p>1)抽出開始時に Access 側の VBA マクロを実行して不足集計テーブル（T_出荷予定集計）を更新し、2) T_出荷予定集計から不足対象を抽出、3) 在庫や洗浄依頼のロットを収集、4) 各品番ごとに必要数に達するまで順にロットを割り当てます。その後、検査員マスタの勤務時間・スキル・固定情報と照合し、公平な割当を実行します。</p>
      <ul>
        <li>不足数は Access 側の集計結果（T_出荷予定集計の不足数）を使用します。</li>
        <li>在梱包数は T_出荷予定集計の「梱包完了合計」を優先して使用します。</li>
        <li>不足数がマイナスの品番のみ取り出し、ロット割当対象とする</li>
        <li>洗浄依頼と登録済品番も独立したロットとして統合し、必要に応じて追加する</li>
        <li>割当結果は Excel/CSV/Google Sheet および UI 上に表示される</li>
      </ul>
    </div>

    <div class="section">
      <h2>検査員割当の重要ルール</h2>
      <div class="rule-card">
        <strong>勤務時間</strong>
        <p>1) 検査員ごとの合計勤務時間は 1 日 8 時間を基準とし、0.05 時間（3 分）のバッファを含めてチェックします。2) 緩和時には最大 10%（当日洗浄品は 20%）の超過が許されます。</p>
      </div>
      <div class="rule-card">
        <strong>同一品番の制限</strong>
        <p>1) 基本は同一検査員に同じ品番を 4 時間以上割り当てない。2) 初期割当で緩和した場合は、後続の最適化フェーズで優先的に修正します。3) 緩和の対象は特定品番と当日洗浄・先行検査品です。</p>
      </div>
      <div class="rule-card">
        <strong>同日洗浄・先行検査の制約</strong>
        <p>1) 同一品番・品名で複数ロットがある場合、原則、検査員を重複させません。2) 同一品名で違う品番でも混合しないよう、品名単位で割当履歴を追跡しています。3) それでも割当が見つからない場合は、差し替えのスワップや時間緩和を検討します。</p>
      </div>
      <div class="rule-card">
        <strong>固定検査員と登録済み品番</strong>
        <p>登録済み品番リストには固定検査員の情報を持たせられます。UI 上で「検査員固定」「登録変更」ボタンから更新し、`InspectorAssignmentManager` に直接渡すことで、優先的に割り当てます。</p>
      </div>
      <div class="rule-card">
        <strong>先行検査品の登録補助</strong>
        <p>登録済み品番には号機・割当て人数・曜日・有効設定を持たせられます。号機を指定した場合は該当号機のロットのみ抽出し、割当て人数はロット数に対して均等割りを行います。曜日は「未設定/各曜日」を指定でき、当日の曜日に一致する品番のみ自動で有効になります。手動の有効/無効は自動判定より優先されます。</p>
      </div>
    </div>

    <div class="section">
      <h2>例外と緩和ポリシー</h2>
      <ul>
        <li>新製品チームや当日洗浄系のロットは最優先で割当を試み、それでも割れないときに時間緩和やタブー解除を行います。</li>
        <li>当日の検査員休暇情報は Google Sheets から取得し、不在の検査員を自動で除外します。</li>
        <li>割当済みロットに重複があれば優先度（当日・洗浄・先行・翌営業日・以降）をつけて重複削除します。</li>
      </ul>
    </div>

    <div class="section">
      <h2>座席表の操作手順</h2>
      <p>座席表では視覚的にロットの割当を確認・入れ替えられます。変更を反映させるには、以下の順番で操作してください。</p>
      <ul>
        <li>アプリの座席表ボタンでブラウザを開きます（ローカルHTTPサーバから座席表HTMLを表示します）。</li>
        <li>ブラウザ上でロット/座席を編集したら、【変更を保存】を押して共有上の <code>seating_chart.json</code> に保存します。</li>
        <li>ブラウザ上で席やロットを移動したら、アプリUIに戻って「ロット振分変更反映」ボタンをクリックし、表の変更内容をテーブルに取り込みます。</li>
        <li>反映完了の案内を確認したら、「Googleスプレッドシートへ出力」ボタンを押して、最新の割当を共有してください。</li>
      </ul>
      <p>保存先はアプリ側設定（共有上の <code>seating_chart.json</code>）に統一されており、手動でのコピーは不要です。</p>
    </div>

    <div class="section">
      <h2>ロット分割とハイライト</h2>
      <ul>
        <li>ロット分割は座席表UIから手動で行います（右クリックメニュー）。</li>
        <li>分割後は同一行の複数検査員列に割当され、検査時間は検査員人数で再計算されます。</li>
        <li>ロット数量は分割後も変更しません。</li>
        <li>分割ロットは同一グループとしてハイライトされ、該当検査員カードの枠も強調表示されます。</li>
        <li>同一ロットIDが複数割当されている場合も、同様にハイライト対象です。</li>
        <li>ロットカードのマウスオーバー時は、対象カードのみ専用色で強調表示されます。</li>
      </ul>
    </div>

    <div class="section">
      <h2>参考</h2>
      <p>このヘルプは運用に合わせて更新されます。UI や Excel 出力などを通じてルールを確認し、運用チームで共有してください。</p>
    </div>
  </div>
</body>
</html>
