# CHANGELOG

## v1.2.6 (2026-01-23)
- UI: 先行検査品/登録済み品番の曜日を複数選択（平日）に対応し、土日を削除、曜日表示幅を拡大。(`app/ui/ui_handlers.py`)
- UI: 追加割当ダイアログで品番ごとの上書き設定（ロット数/工程/号機/割当人数/固定検査員）、直接入力、マウスホイールスクロールに対応。上書きは追加割当時のみ適用。(`app/ui/ui_handlers.py`)
- 仕様: 追加割当のカスタム品番に上書き設定を反映、優先ロット保護の解除は候補が存在しない場合はスキップ、複数人割当ロットで品番ごとの割当数制限を緩和。(`app/assignment/inspector_assignment_service.py`)

## v1.2.5 (2026-01-22)
- 変更: 出荷予定日の並び順を変更（`inspector_assignment_service.py`, `ui_handlers.py`）
  - 先行検査品を優先度1、当日洗浄上がり品を優先度2に変更（結果の表示順序のみ変更、割当てロジックは変更なし）
- 追加: ログファイルの冒頭にユーザー名とバージョン情報を追加（`ui_handlers.py`）
  - ログファイル作成時に`user : {ユーザー名}`と`APP_VERSION = {バージョン}`を自動記載

## v1.2.4 (2026-01-21)
- 追加: 先行検査品の登録項目拡張（号機/割当て人数/曜日/有効設定）とUI統一（`ui_handlers.py`）
  - 曜日（未設定/各曜日）＋有効設定（自動/有効/無効）で当日対象を自動制御
  - 登録変更ダイアログに工程名・曜日・有効設定を追加し、表示/枠線を統一
  - 登録済み品番リストに曜日/有効設定の表示を追加し、色/固定幅を調整
- 追加: 登録済み品番リストに当日実行可否（対象/対象外）を表示（`ui_handlers.py`）
- 追加: 先行検査品の検査割当て人数に応じた均等割当とプール最適化（`inspector_assignment_service.py`）
  - ロット数に対する割当人数の均等配分、候補の再利用制御、偏り抑制
- 追加: 先行検査品の登録と抽出対象外（品番）マスタの連動（`ui_handlers.py`）
  - 登録追加時に抽出対象外へ自動追加、削除時に未使用なら自動削除
- 改善: 固定検査員一覧ダイアログとツールチップのUI刷新（`ui_handlers.py`）
  - アプリ配色に合わせた表示とホバー案内を追加

## v1.2.3 (2026-01-16)
- 改善: 座席表UIの分割ロット反映を安定化（`ui_handlers.py`）
  - 分割ロットの検査員割当を`lot_id`/`lot_key`/`row_key`の優先順で反映
  - 検査員列の抽出を厳格化し、分割反映が崩れる問題を修正
- 改善: 座席表UIの同一ロットハイライトを拡張（`seat_ui.py`）
  - 分割ロットだけでなく、同一`lot_id`が複数ある場合もハイライト
  - ハイライト時に該当検査員カードと未割当枠も強調表示
  - マウスオーバー中のロットカードを専用色で強調
  - 当日出荷/当日洗浄の表示色より枠ハイライトを優先表示
- 改善: 座席表反映のデバッグ出力を整理（`ui_handlers.py`）

## v1.2.2 (2026-01-15)
- 改善: 勤務時間の判定をロット日付基準に統一し、将来日ロットの誤除外を防止（`inspector_assignment_service.py`）
  - 非対称分配・検査員選択・置換の勤務時間参照を`lot_date`に統一
  - 偏り是正の履歴再計算で`lot_date`を反映
- 改善: フェーズ3.5で勤務時間超過のみの品番は一括クリアせず個別是正へ（`inspector_assignment_service.py`）
- 改善: 最終違反再処理の重複実行を抑止（`inspector_assignment_service.py`）
- 改善: 検査員列を10人まで拡張し、UI/出力の表示を拡張（`ui_handlers.py`, `google_sheets_exporter_service.py`）

## v1.2.1 (2026-01-14)
- 改善: 90%未満検査員の割当不能原因をデバッグ時に分解表示（`inspector_assignment_service.py`）
  - 未割当ロット分割時間の最小/中央値/最大を出力し、残り時間とのギャップを可視化
  - 残り時間内ロット数と候補含有数を表示
  - 除外理由を「勤務時間上限」「品番4h上限」「休暇」「候補外」などに分類

## v1.2.0 (2026-01-13)
- 改善: 検査員割当の安定化・優先順位の保持・偏り是正の強化（`inspector_assignment_service.py`）
  - 固定検査員の名前を正規化し、先行検査品での固定割当を安定化
  - 固定検査員の最終調整とカバレッジ確保を追加
  - フェーズ3.5の違反是正を厳格化し、優先ロットでも違反は未割当へ
  - 最終是正後の勤務時間超過解消と、偏り是正の追加パスを追加
  - 余裕検査員への追加割当フェーズを80%/90%/95%まで拡張し、偏り許容+0.5hのガードを追加
  - ログの重複出力を抑制（候補除外/未割当再処理/未割当通知）

## v1.1.9 (2026-01-09)
- 修正: 洗浄二次処理依頼からのロット取得で、指示日に日付が入力されている場合の処理を改善（`cleaning_request_service.py`）
  - `instruction_date`が指定されているリクエストと`date_list`が指定されているリクエストを分離して処理するように変更
  - `instruction_date`が指定されている場合は、その日付を直接Accessデータベースから取得するように修正
  - `pd.to_datetime`で`2026-01-05 00:00:00`が`NaT`になる問題を解決するため、`parse_date_safe`関数を追加して明示的なフォーマット指定で日付をパースするように修正
  - 不要なデバッグログとコードを削除

## v1.1.8 (2026-01-08)
- 追加: 検査対象外ロットをARAICHATへ送信する際のメッセージに「客先」と「品名」を追加（`chat_notification_service.py`）
  - メッセージフォーマットを更新し、出荷予定日の後に「客先」、品番の後に「品名」を表示するように変更
- 改善: 出荷予定日の異常値チェックと分割検査時間の再計算を追加（`inspector_assignment_service.py`）
  - 出荷予定日の異常な日付（1900年未満または2100年超）を検出し、警告メッセージをログに記録する処理を実装
  - 異常な日付はNaTとして処理される
  - 分割検査時間を実際の検査員数に基づいて再計算し、検査時間を均等に分配するロジックを追加
  - チーム情報更新後に分割検査時間を最終的に再計算する処理を強化

## v1.1.7 (2026-01-07)
- 改善: 偏り是正フェーズでの10%超過解消処理を追加（`inspector_assignment_service.py`）
  - 偏り是正パス終了時に10%超過を検出した検査員から、他の検査員へ再割当を行う処理を追加
  - 当日洗浄上がり品の制約（品番単位・品名単位）を正しく更新する処理を追加
  - `filter_available_inspectors`の呼び出しを修正し、`get_available_inspectors`を使用するように変更
  - 10%超過を検出した検査員のロットを順次再割当し、超過分を解消する処理を実装
  - 偏り是正の段階で既に存在していた10%超過を解消可能に
  - 当日洗浄上がり品の制約違反を防止
  - 検査時間の偏り改善と10%超過の両立を実現

## v1.1.6 (2026-01-07)
- 修正: 洗浄二次処理依頼スプレッドシート「依頼一覧」シートの「詳細・備考」から日付を解析する際、12月の日付が現在の月より前の場合は前年として解釈するように修正（`cleaning_request_service.py`）
- 修正: 上記修正により、3D025-G4960が正しく抽出されるようになった

## v1.1.5 (2026-01-06)
- 改善: 最終検証フェーズで3営業日以内のロットは新製品チームも候補に追加し、未割当を減らす処理を強化（`inspector_assignment_service.py`）
- 改善: 上記判定と新製品チーム取得のデバッグログを追加し、調査しやすく調整
- 変更: バージョン情報を更新（`version.py`）

## v1.1.4 (2026-01-05)
- 追加: `cleaning_request_service.py` と `ui_handlers.py` に洗浄指示の行番号を追加し、重複判定に行番号を考慮するよう更新

## v1.1.3 (2025-12-25)
- 修正: Access VBA 実行時に「既にこのデータベースは開いています」で失敗するケースを回避（`DispatchEx`優先＋再Open）

## v1.1.2 (2025-12-25)
- 改善: 進捗バー表示の体感を最適化（Access VBA中のpulse停止対策、配分/速度調整）
- 変更: 要日出荷（当日/過去）のロットは最終検証で未割当に落とさず割当維持を優先

## v1.1.1 (2025-12-25)
- 追加: バージョン情報の一元管理（`version.py`）、タイトルバー表示、ヘルプ→バージョン情報（About）
- 更新: README/ヘルプの記載を現行仕様に同期（座席表はローカルHTTPサーバ経由で共有JSONへ保存）

## v1.1.0 (2025-12-24)
- 追加: Access VBA 連携による不足集計更新（抽出開始時に `ShukkahusokuCalculate` 実行）
- 修正: Access VBA 呼び出しを管理者手順に合わせて安定化（`Dispatch`/`run`、日付 `yyyy/mm/dd`）
- 改善: 進捗バー表示を調整（パルス表示・表示配分の調整）
- 変更: 座席表UIレイアウト調整
- 改善: ログ出力のバッファリング、休暇/洗浄のキャッシュ、割当最適化の内部改善
